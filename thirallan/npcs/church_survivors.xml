<?xml version="1.0" encoding="utf-8" ?>
<npcs>

  <quest id="rebuild_monastery" exp="1000" giver="gilbert_template">
    <flag id="andreas_recruited" name="quests.misc.find_miner" tile="andreas_hidden" />
    <flag id="merchants_recruited" name="quests.misc.find_merchants" tile="pyrrhos_hidden" />
    <flag id="iterol_recruited" name="quests.misc.find_scientist" tile="iterol_hidden" />
  </quest>

  <procedure id="gilbert.npc">
    <choose>
      <choose if="!player.hasQuest('rebuild_monastery')">
        <section if="getFlag('gilbert.rejected')">
          <menu section="common">
            <dialogue section="gilbert" id="rebuild8" speaker='this' />
            <choice id="yes">
              <dialogue section="gilbert" id="rebuild3" speaker='this' />
              <dialogue section="gilbert" id="rebuild4" speaker='this' />
              <dialogue section="gilbert" id="rebuild5" speaker='this' />
              <dialogue section="gilbert" id="rebuild6" speaker='this' />
            </choice>
            <choice id="no">
              <dialogue section="gilbert" id="rebuild7" speaker='this' />
            </choice>
          </menu>
          <stop/>
        </section>
        <section>
          <dialogue section="gilbert" id="rebuild1" speaker='this' />
          <menu section="common">
            <dialogue section="gilbert" id="rebuild2" speaker='this' />
            <choice id="yes">
              <dialogue section="gilbert" id="rebuild3" speaker='this' />
              <dialogue section="gilbert" id="rebuild4" speaker='this' />
              <dialogue section="gilbert" id="rebuild5" speaker='this' />
              <dialogue section="gilbert" id="rebuild6" speaker='this' />
              <quest id="rebuild_monastery" ask="false" />
              <show tooltip="popup" text="common.found_note{value:'Thirallan Inhabitants'}" x="0.5" y="0.0625" hold="200" />
            </choice>
            <choice id="no">
              <dialogue section="gilbert" id="rebuild7" speaker='this' />
            </choice>
          </menu>
          <stop/>
        </section>
      </choose>
      <choose if="player.hasQuest('rebuild_monastery') && !player.questComplete('rebuild_monastery')">
        <section if="!player.canCompleteQuest('rebuild_monastery')">
          <menu section="common">
            <dialogue section="gilbert" id="rebuild9" speaker='this' />
            <choice id="yes">
              <dialogue section="gilbert" id="rebuild3" speaker='this' />
              <dialogue section="gilbert" id="rebuild4" speaker='this' />
              <dialogue section="gilbert" id="rebuild5" speaker='this' />
              <dialogue section="gilbert" id="rebuild6" speaker='this' />
            </choice>
            <choice id="no">
              <dialogue section="gilbert" id="rebuild10" speaker='this' />
            </choice>
          </menu>
        </section>
        <section if="player.canCompleteQuest('rebuild_monastery')">
          <dialogue section="gilbert" id="rebuild11" speaker='this' />
          <dialogue section="gilbert" id="rebuild12" speaker='this' />
          <complete quest="rebuild_monastery" />
        </section>
      </choose>
    </choose>
  </procedure>

  <procedure id="hadvarr.npc">
    <dialogue section="hadvarr" id="notOne" speaker='this' />
  </procedure>

  <npc id="gilbert_template" tile="gilbert" action="talk" talk_sfx="talking1">
    <operate>
      <section>
        <set id="this" value="this" />
        <run procedure="gilbert.npc" />
      </section>
    </operate>
  </npc>
  <npc id="hadvarr_template" tile="hadvarr" action="talk" talk_sfx="talking4">
    <operate>
      <section>
        <set id="this" value="this" />
        <run procedure="hadvarr.npc" />
      </section>
    </operate>
  </npc>
  <npc id="gilbert_cathedral" extends="gilbert_template" sleepDay="true" night="true"><idle class="wander" fromX="0" toX="25" /></npc>
  <npc id="hadvarr_cathedral" extends="hadvarr_template" sleepDay="true" night="true"><idle class="wander" fromX="0" toX="20" /></npc>
  <npc id="gilbert_monastery" extends="gilbert_template"><idle class="wander" fromX="50" toX="126" /></npc>
  <npc id="hadvarr_monastery" extends="hadvarr_template"><idle class="wander" fromX="50" toX="126" /></npc>

  <npc id="azriel" tile="azriel" action="talk" talk_sfx="talking5">
    <idle class="wander" fromX="50" toX="126" />
    <operate>
      <dialogue section="azriel" id="notOne" speaker='this' />
    </operate>
  </npc>
  <npc id="ligart" tile="ligart" action="talk" night="true" sleepDay="true">
    <idle class="wander" fromX="50" toX="126" />
    <operate>
      <dialogue section="ligart" id="placeholder" speaker='this' />
    </operate>
  </npc>

  <npc id="andreas_monastery" mine="4" tile="andreas" action="talk" talk_sfx="talking5">
		<idle class="mineOre"><loot id="coal" /></idle>
    <operate><dialogue section="andreas" id="monastery" speaker='this' /></operate>
	</npc>

  <!--enemy id="lightning_wyvern" tile="adult_dragon" health="30" defense="3" fps="10" type="dragon" color="00008b" colorScale="1.5">
		<lootSet><loot id="fire_gem" /></lootSet><sound id="death" value="dragon_death" /><sound id="hit" value="dragon_hit" />
		<lootSet><loot id="dragonblood" count="3" /></lootSet>
		<tile id="hadvarr" name="hadvarr" offsetX="-1" offsetY="-1" />
		<attack type="breath" damage="5" range="13" repeat="2" animation="fire" state="standing" sfx="dragon_atk">
			<projectile tile="fire" glow="true" speed="2" frames="8" breakTile="2" breakPower="4" scaleTo="3" offsetX="-40" offsetY="8" hitEffect="fire_med" color="f9be0b" colorScale="2">
				<light tile="light.small" color="cc5500" />
			</projectile>
		</attack>
		<attack type="breath" damage="5" range="13" repeat="2" animation="hover_fire" state="flying" sfx="dragon_atk">
			<projectile tile="fire" glow="true" speed="2" frames="8" breakTile="2" breakPower="4" scaleTo="3" offsetX="-33" offsetY="-5" hitEffect="fire_med" color="f9be0b" colorScale="2">
				<light tile="light.small" color="cc5500" />
			</projectile>
		</attack>
	</enemy-->

  <procedure id="paul.npc">
    <choose>
      <section if="this.area.id == 'paul_cell' && this.info.id == 'chained_paul'">
        <menu section="common">
          <dialogue section="paul" id="free1" speaker='this' />
          <choice id="yes">
            <dialogue section="paul" id="free2" speaker='this' />
            <object id="paul" x="this.tile_x" y="this.tile_y" />
            <remove object="this" />
            <action>setFlag('dungeon_conflict', true);</action>
          </choice>
          <choice id="no" />
        </menu>
      </section>
      <dialogue section="paul" id="free2" speaker='this' if="this.area.id == 'paul_cell'" />
    </choose>
  </procedure>

  <npc id="paul_template" action="talk" talk_sfx="talking2">
    <operate>
      <section>
        <set id="this" value="this" />
        <run procedure="paul.npc" />
      </section>
    </operate>
  </npc>
  <npc id="chained_paul" extends="paul_template" tile="chained_paul" />
  <npc id="paul" extends="paul_template" tile="paul" />
  <npc id="armored_paul" extends="paul_template" tile="armored_paul" />

  <!--
    Player pos: (27, 14)
    Paul pos: (29, 14)
    Gilbert pos: (25, 14)
    Azriel init pos: (17, 16)
    Azriel mid pos: (20, 16)
    Azriel new pos: (22, 14)
    Iterol init pos: (17, 16)
    Iterol new pos: (20, 16)
  -->
  <procedure id="dungeon_conflict">
    <object id="paul" x="29" y="14" />
    <object id="gilbert_monastery" x="25" y="14" facing="right"/>
    <object id="azriel" x="17" y="16" facing="right" />
    <object id="iterol_cathedral" x="16" y="16" facing="right" />


    <dialogue section="gilbert" id="dungeon_conflict1" speaker="gilbert_monastery" />
    <dialogue section="paul" id="dungeon_conflict1" speaker="paul" />
    <dialogue section="gilbert" id="dungeon_conflict2" speaker="gilbert_monastery" />

    <lerp object="azriel" deltaX="3" seconds="0.5" />
    <move object="azriel" x="20" y="16" />
    <facing object="gilbert_monastery" dir="left" />
    <wait seconds="0.5">
      <operate object="azriel" />
      <operate object="gilbert_monastery" />
    </wait>

    <dialogue section="azriel" id="dungeon_conflict1" speaker="azriel" />
    <dialogue section="gilbert" id="dungeon_conflict3" speaker="gilbert_monastery" />

    <lerp object="azriel" deltaX="2" seconds="0.5" />
    <move object="azriel" x="22" y="16" />
    <wait seconds="0.5">
      <operate object="azriel" />
    </wait>
    <lerp object="azriel" deltaY="-2" seconds="0.5" />
    <move object="azriel" x="22" y="14" />
    <wait seconds="0.5">
      <operate object="azriel" />
    </wait>
    
    <dialogue section="azriel" id="dungeon_conflict2" speaker="azriel" />
    <dialogue section="azriel" id="dungeon_conflict3" speaker="azriel" />

    <lerp object="iterol_cathedral" deltaX="4" seconds="0.5" />
    <move object="iterol_cathedral" x="20" y="16" />
    <wait seconds="0.5">
      <operate object="iterol_cathedral" />
    </wait>

    <dialogue section="iterol" id="dungeon_conflict1" speaker="iterol_cathedral" />
    <dialogue section="iterol" id="dungeon_conflict2" speaker="iterol_cathedral" />
    <dialogue section="iterol" id="dungeon_conflict3" speaker="iterol_cathedral" />

    <menu section="common">
      <dialogue section="paul" id="dungeon_conflict2" speaker="paul" />
      <choice id="dungeon_conflict_gilbert">
        <dialogue section="iterol" id="dungeon_conflict4" speaker="iterol_cathedral" />
        <dialogue section="azriel" id="dungeon_conflict4" speaker="azriel" />
        <facing object="gilbert_monastery" dir="right" />
        <wait seconds="0.25">
          <operate object="gilbert_monastery" />
        </wait>
        <dialogue section="gilbert" id="dungeon_conflict4" speaker="gilbert_monastery" />
        <section with="fade">
          <remove object="gilbert_monastery" />
          <remove object="azriel" />
          <remove object="paul" />
          <remove object="iterol_cathedral" />
          <wait seconds="0.25">
            <operate object="gilbert_monastery" />
            <operate object="azriel" />
            <operate object="paul" />
            <operate object="iterol_cathedral" />
          </wait>
          <scene id="thirallan_alchemist" show="paul_death" />
          <action>setFlag('paul_killed', true);</action>
        </section>
      </choice>
      <choice id="dungeon_conflict_iterol">
        <dialogue section="azriel" id="dungeon_conflict5" speaker="azriel" />
        <dialogue section="gilbert" id="dungeon_conflict5" speaker="gilbert_monastery" />
        <dialogue section="iterol" id="dungeon_conflict5" speaker="iterol_cathedral" />
        <section with="fade">
          <remove object="gilbert_monastery" />
          <remove object="azriel" />
          <remove object="paul" />
          <remove object="iterol_cathedral" />
          <action>setFlag('paul_experiment', true);</action>
        </section>
      </choice>
      <choice id="dungeon_conflict_azriel">
        <dialogue section="gilbert" id="dungeon_conflict6" speaker="gilbert_monastery" />
        <dialogue section="iterol" id="dungeon_conflict6" speaker="iterol_cathedral" />
        <dialogue section="azriel" id="dungeon_conflict6" speaker="azriel" />
        <section with="fade">
          <remove object="gilbert_monastery" />
          <remove object="azriel" />
          <remove object="paul" />
          <remove object="iterol_cathedral" />
          <action>setFlag('paul_freed', true);</action>
        </section>
      </choice>
    </menu>
  </procedure>

</npcs>
