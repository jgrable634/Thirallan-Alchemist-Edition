<?xml version="1.0" encoding="utf-8" ?>
<areas>
	<area id="RB.crater">
		<structure id="RB_crashed_ship" x="11" y="20" />
		<structure id="RB_old_ship_door" x="20.8125" y="4.625" />
		<object id="RB_old_ship.marker" x="20.8125" y="4.625" />
		<object id="RB_old_ship_notice" x="10" y="22" />
	</area>
	<procedure id="heat_damage">
		<choose>
			<section if="Area.getXML(area.id).xml.get('allowHeatDamage') == 'true' && player.vehicle == null">
				<action>
					if(!(player.isEquipped("draemordion_helm") && player.isEquipped("draemordion_armor"))){
						player.loseHealth(5,FLAG_IGNORE_DEFENSE|FLAG_HIDE_ATTACKER);
						player.damageNotification(5,false,player);
						trace("PlayerSection");
					}
				</action>
				<action>
					if(area.isWater(player.tile_x,player.tile_y)){
						player.loseHealth(20,FLAG_IGNORE_DEFENSE|FLAG_HIDE_ATTACKER);
						player.damageNotification(20,false,player);
					}
				</action>
				<invokeLater seconds="0.25">
						<run procedure="heat_damage" />
				</invokeLater>
			</section>
			<section if="Area.getXML(area.id).xml.get('allowHeatDamage') == 'true'">
				<action>
					if(!(player.isEquipped("draemordion_helm") && player.isEquipped("draemordion_armor"))){
						player.vehicle.loseHealth(5,FLAG_IGNORE_DEFENSE|FLAG_HIDE_ATTACKER);
						player.vehicle.damageNotification(5,false,player);
						trace("VehicleSection");
					}
				</action>
				<action>
					if(area.isWater(player.vehicle.tile_x,player.vehicle.tile_y)){
						player.vehicle.loseHealth(20,FLAG_IGNORE_DEFENSE|FLAG_HIDE_ATTACKER);
						player.vehicle.damageNotification(20,false,player);
					}
				</action>
				<invokeLater seconds="0.25">
						<run procedure="heat_damage" />
				</invokeLater>
			</section>
		</choose>
	</procedure>
	<area id="robot_start" width="256" height="96" background="stars.dwarf" planet="robot_rebellion" looping="true" water="RB_lava" water_anim="RB_lava" allowHeatDamage="true">
		<tiles id="sci1.grass.scorched" y="0" />
		<tiles id="scorched.dirt" start="0" end="0.5" />
		<tiles id="obsidian" start="0.5" end="1" />
		<tiles id="blackstone" y="95" />
		<ore id="coal" start="0.2" end="0.4" percent="0.0125" tile="scorched.dirt" />
		<ore id="quartz" start="0.4" end="0.5" percent="0.01" tile="scorched.dirt" />
		<ore id="lava" start="0.7" end="0.9" percent="1" tile="obsidian" />
		<ore id="uranium" start="0.9" end="1" percent="0.005" tile="obsidian" />
		<ore id="exotic_matter" start="0.9" end="1" percent="0.004" tile="obsidian" />
		<appendArea id="RB.crater" offsetX="120" offsetY="60" />
		<objects id="large_drone" startX="1" endX="255" startY="-3" endY="-3" minDist="60" maxDist="75" count="5" />
		<spawner id="large_drone" time="500" count="8" fromX="1" toX="255" fromY="-3" toY="-3" ground="false" />
		<objects id="small_tank" startX="1" endX="255" startY="-1" endY="-1" minDist="80" maxDist="85" count="5" />
		<spawner id="small_tank" time="500" count="6" fromX="1" toX="255" fromY="-1" toY="-1" />
		<init>
			<runAreaLoad/>
			<action>
				// Done by Etrotta
				function generateOreChunk(area,centerX,centerY,ore,radius,p){
					var i = area.addTileIndex(ore); //do not worry, if it already exists it returns instead of re-adding.
					for (x in -radius...radius+1){
						for (y in 0...radius-Math.abs(x)){
							if (Math.random() &lt; p) area.setTile(centerX + x, centerY + y, ORE_LAYER, i);
							if (Math.random() &lt; p) area.setTile(centerX + x, centerY - y, ORE_LAYER, i);
						}
					}
				}
				function generateWaterChunk(area,centerX,centerY,radius,p){
					for (x in -radius...radius+1){
						for (y in 0...radius-Math.abs(x)){
							if (Math.random() &lt; p){mine(centerX + x, centerY + y); area.setWater(centerX + x, centerY + y);}
							if (Math.random() &lt; p){mine(centerX + x, centerY - y); area.setWater(centerX + x, centerY - y);}
						}
					}
				}
			</action>
			<action>
				var i = 0;
				var chunksCount = 15;
				while (i &lt; chunksCount){
					var x = randInt(5,130);
					var y = randInt(10,90);
					var p = Utils.clamp(Math.random(),0.25,0.75);
					var radius = randInt(3,6);
					generateOreChunk(area,x,y,"moltanium_ore",radius,p);
					generateWaterChunk(area,x,y,radius+2,p+0.2);
					i++;
				}

				i = 0;
				while (i &lt; chunksCount){
					var x = randInt(160,250);
					var y = randInt(10,90);
					var p = Utils.clamp(Math.random(),0.25,0.75);
					var radius = randInt(3,6);
					generateOreChunk(area,x,y,"moltanium_ore",radius,p);
					generateWaterChunk(area,x,y,radius+2,p+0.2);
					i++;
				}
			</action>
		</init>
		<onLoad>
			<music id="orbit" seconds="1" />
			<section if="player.getKillCount('RB_boss') == 0 && player.hasQuest('RB_old_ship') && !getFlag('RB_ship_marked')">
				<dialogue section="player" id="RB_old_ship_detect_near" speaker='player' />
				<action>setFlag('RB_ship_marked',true);</action>
				<locate id="RB_old_ship.marker" />
			</section>
			<section>
				<action>
					area.renderer.addChildAt(area.renderer.getChildAt(1), 6);
					if(!(player.isEquipped("draemordion_helm") && player.isEquipped("draemordion_armor"))){
						player.showWarning(getText('warning.heat_protection'));
					}
				</action>
				<run procedure="heat_damage" />
			</section>
			<section if="player.isEquipped('water_pump')">
				<dialogue text='Nice try... You are not vacuuming up my precious lava. Lemme unequip that [item="water_pump"] for you.' />
				<action>player.equipment.unequip("back",player,true);</action>
			</section>
			<section if="area.getStructureById('RB_old_ship.crack2') == null && player.getKillCount('RB_boss') > 0">
					<object id="RB_old_ship.decoy" x="138.125" y="77.0625" />
					<light x="138.125" y="77.0625" size="10" />
					<pan toObject="area.getObject('RB_old_ship.decoy')" seconds="1" />
					<wait seconds="0.5" />
					<object id="RB.explosion" x="138.125" y="77.0625" />
					<structure id="RB_old_ship.crack2" x="138.125" y="77.0625">
						<teleport area="RB_old_ship.cave2" x="14" y="43" allowReturn="true" with="ellipse" />
					</structure>
					<sound id="explosion" />
					<action>for(x in 138...142) for(y in 74...78) mine(x,y);</action>
					<wait seconds="2">
						<operate object="area.getObject('RB.explosion')" />
					</wait>
			</section>
		</onLoad>
	</area>
	<area id="RB_old_ship_boss" width="32" height="16" external="robot_start">
		<tiles id="ship" start="0" end="1" />
		<action>for(y in 5...10) for(x in 8...24) mine(x, y,2);</action>
		<structure id="RB_old_ship_door.exit" x="20" y="9.1" />
		<light x="20" y="8" size="3" /><light x="21" y="8" size="3" /><light x="20" y="9" size="3" /><light x="21" y="9" size="3" />
		<structure id="sci1.light" x="10" y="6" />
		<structure id="sci1.light" x="14" y="6" />
		<structure id="sci1.light" x="18" y="6" />
		<structure id="sci1.light" x="22" y="6" />
		<structure id="RB_old_ship.bridge.entrance" x="8" y="9.1" />
		<object id="RB_boss" x="8" y="9" facing="right" />
		<init><runAreaLoad/></init>
		<onLoad><section if="area.getObject('RB_boss') != null"><run procedure="RB_boss_start" /></section></onLoad>
	</area>
	<area id="RB.bridge" x="-8" y="-8" width="32" height="25" allowHeatDamage="true">
		<tiles id="obsidian" start="0" end="1" />
		<mine start="0" end="1" /><tiles id="empty" start="0" end="1" />
		<action>
			for(x in 10...14) mine(x, 1); mine(13,2); for(y in 2...4) for(x in 7...13) mine(x, y);
			mine(6, 3); for(x in 6...11) mine(x, 4); for(x in 8...11) mine(x, 5); for(x in 8...10) mine(x, 6);
		</action>
		<structure id="science1.bridge" x="0" y="8" />
		<structure id="RB.bridge.exit" x="7" y="6" />
		<object id="RB.bridge.nav" x="5" y="4" />
		<object id="RB.bridge.nav.broken" x="6" y="2" />
		<object id="RB.bridge.nav.broken" x="11" y="4" />
		<object id="RB.bridge.nav.broken" x="14" y="1" />
		<light x="7" y="5" size="3" /><light x="7" y="6" size="3" />
		<init><runAreaLoad/></init>
		<onLoad>
			<section>
				<action>
					if(!(player.isEquipped("draemordion_helm") && player.isEquipped("draemordion_armor"))){
						player.showWarning(getText('warning.heat_protection'));
					}
				</action>
				<run procedure="heat_damage" />
			</section>
		</onLoad>
	</area>
	<procedure id="RB_old_ship_opening">
		<section>
			<object id="RB_old_ship.decoy" x="138.125" y="77.0625" />
			<light x="138.125" y="77.0625" size="10" />
			<pan toObject="area.getObject('RB_old_ship.decoy')" seconds="1" />
			<wait seconds="0.5" />
			<action>for(x in 138...143) for(y in 73...78) mine(x,y);</action>
			<object id="RB.explosion" x="138.125" y="77.0625" />
			<structure id="RB_old_ship.crack2" x="138.125" y="77.0625" />0
			<sound id="explosion" />
			<wait seconds="2">
				<operate object="area.getObject('RB.explosion')" />
			</wait>
		</section>
	</procedure>

	<procedure id="RB_ship_robots_lava">
		<object id="RB.explosion" x="27" y="11" />
		<action>for(x in 30...33){mine(x,9); area.setWater(x,9);}</action>
		<sound id="explosion" />
		<object id="RB.explosion" x="47" y="11" />
		<action>for(x in 50...53){mine(x,9); area.setWater(x,9);}</action>
		<sound id="explosion" />
		<action>for(y in 14...18) evalXml('&lt;object id="flame_wall" x="13" y="'+y+'" />'); player.setKillCount('moltanium_RB_boss_abyssalFight',0);</action>
		<object id="moltanium_RB_boss_abyssalFight" x="20" y="15" />
		<object id="moltanium_RB_boss_abyssalFight" x="40" y="15" />
		<structure id="RB_old_ship_crack1" x="148.8125" y="74.375" area="robot_start" />
		<structure id="RB_old_ship.crack1.ret" x="9" y="15">
			<teleport area="robot_start" x="148.8125" y="74.375" with="ellipse" />
		</structure>
		<remove structure="player.areas.get('RB_old_ship.cave2').getStructureById('RB_robots_door')" />
		<run procedure="RB_ship_robots_moarLava" />
	</procedure>

	<procedure id="RB_ship_robots_moarLava">
		<section if="area.id == 'RB_ship_robots'">
			<action>for(x in 30...33) area.setWater(x,9);</action>
			<action>for(x in 50...53) area.setWater(x,9);</action>
			<invokeLater seconds="1">
				<run procedure="RB_ship_robots_moarLava" />
			</invokeLater>
		</section>
	</procedure>

	<area id="RB_ship_robots" width="64" height="32" external="robot_start" planet="robot_rebellion" water="RB_lava" water_anim="RB_lava" allowHeatDamage="true">
		<tiles id="ship" start="0" end="1" />
		<action>for(y in 10...24) for(x in 10...56) mine(x, y);</action>
		<action>for(y in 10...24){setTile(12,y,"ship"); setTile(13,y,"ship");} for(y in 14...18){mine(12,y); mine(13,y);}</action>
		<structure id="RB_robots_door" x="10" y="15">
			<teleport area="RB_old_ship.cave2" x="65" y="15" with="ellipse" />
		</structure>
		<object id="abyssal_one_hotspot" x="12" y="22" />
		<object id="abyssal_one_starter" x="1" y="-1" />
		<structure id="moltanium_forge" x="46" y="23" />
		<light x="0" y="32" size="64" />
		<init><runAreaLoad /></init>
		<onLoad>
			<music id="orbit" seconds="1" />
			<section if="area.getObject('abyssal_one_starter') != null">
				<lerp object="area.getObject('abyssal_one_starter')" alpha="0" seconds="0.25" />
				<facing object="area.getObject('abyssal_one_starter')" dir="right" />
			</section>
			<section if="player.isEquipped('water_pump')">
				<dialogue text='Nice try... You are not vacuuming up my precious lava. Lemme unequip that [item="water_pump"] for you.' />
				<action>player.equipment.unequip("back",player,true);</action>
			</section>
			<section>
				<action>
					area.renderer.addChildAt(area.renderer.getChildAt(1), 6);
					if(!(player.isEquipped("draemordion_helm") && player.isEquipped("draemordion_armor"))){
						player.showWarning(getText('warning.heat_protection'));
					}
				</action>
				<run procedure="heat_damage" />
			</section>
		</onLoad>
	</area>

	<area id="RB_old_ship.cave2" width="74" height="64" powered="this.getObject('RB_power_cores') != null">
		<tiles id="ship" start="0" end="1" />
		<action>for(x in 12...31){mine(x, 28); mine(x, 41);} for(y in 16...41) mine(30, y);</action>
		<action>for(y in 42...45) for(x in 12...16) mine(x, y); for(y in 16...41) mine(12, y); for(y in 14...16) for(x in 12...66) mine(x, y); setTile('62', '14', 'ship'); for(x in 2...12){mine(x, 28); mine(x, 41);} for(x in 30...37){mine(x, 28); mine(x, 41);}</action>
		<structure id="RB_old_ship.crack2.ret" x="12" y="44"><teleport area="robot_start" x="138.125" y="77.0625" with="ellipse" /></structure>
		<light x="14" y="43" size="4" />
		<set id="ar" value="[15,19,23,37,31,35,39,43,47,51,55,59]" /><action>shuffle(ar);</action>
		<structure id="medivat1" x="ar[0]" y="15" />
		<structure id="medivat2" x="ar[1]" y="15" />
		<structure id="medivat3" x="ar[2]" y="15" />
		<structure id="medivat4" x="ar[3]" y="15" />
		<structure id="medivat.full1" x="ar[4]" y="15" />
		<structure id="medivat.full2" x="ar[5]" y="15" />
		<structure id="medivat.full3" x="ar[6]" y="15" />
		<structure id="medivat.full4" x="ar[7]" y="15" />
		<structure id="medivat1" x="ar[8]" y="15" />
		<structure id="medivat2" x="ar[9]" y="15" />
		<structure id="medivat3" x="ar[10]" y="15" />
		<structure id="medivat4" x="ar[11]" y="15" />
		<structure id="sci1.light.off" x="ar[0]-1" y="15" />
		<structure id="sci1.light.broken" x="ar[1]-1" y="15" />
		<structure id="sci1.light.broken" x="ar[2]-1" y="15" />
		<structure id="sci1.light.broken" x="ar[3]-1" y="15" />
		<structure id="sci1.light" x="ar[4]-1" y="15" />
		<structure id="sci1.light" x="ar[5]-1" y="15" />
		<structure id="sci1.light" x="ar[6]-1" y="15" />
		<structure id="sci1.light" x="ar[7]-1" y="15" />
		<structure id="sci1.light.off" x="ar[8]-1" y="15" />
		<structure id="sci1.light.broken" x="ar[9]-1" y="15" />
		<structure id="sci1.light.broken" x="ar[10]-1" y="15" />
		<structure id="sci1.light.broken" x="ar[11]-1" y="15" />
		<appendArea id="RB_ship_projection" offsetX="-28" offsetY="36" />
		<appendArea id="RB_ship_power" offsetX="37" offsetY="23" />
		<appendArea id="RB_ship_storage" offsetX="-28" offsetY="23" />
		<appendArea id="RB_ship_destroyed" offsetX="37" offsetY="40" />
		<object id="RB_room_door" x="31" y="41" />
		<object id="ship.doorh" x="31" y="28" />
		<object id="RB_room_door" x="11" y="41" />
		<object id="RB_room_door" x="11" y="28" />
		<object id="RB_ship_robot_permission" x="62" y="15" />
		<structure id="RB_robots_door" x="64" y="15">
			<teleport area="RB_ship_robots" x="10" y="15" />
		</structure>
		<objects id="whip_bot" startX="13" endX="60" startY="14" endY="14" minDist="5" maxDist="7" />
		<spawner id="whip_bot" time="750" count="4" fromX="13" toX="60" fromY="14" toY="14" />
		<objects id="whip_bot" startX="38" endX="95" startY="45" endY="65" minDist="5" maxDist="7" />
	</area>
	<procedure id="unlock_RB_doors">
		<remove object="area.getObject('RB_room_door')" />
		<remove object="area.getObject('RB_room_door')" />
		<remove object="area.getObject('RB_room_door')" />
		<action>setTile(31,41,null); setTile(11,41,null); setTile(11,28,null);</action>
		<object id="ship.doorh" x="31" y="41" />
		<object id="ship.doorh" x="11" y="41" />
		<object id="ship.doorh" x="11" y="28" />
	</procedure>

	<area id="RB_ship_projection" width="30" height="10">
		<tiles id="ship" start="0" end="1" />
		<action>
			for(x in 10...19) for(y in 1...9) mine(x,y);
			for(x in 19...31) mine(x,5);
		</action>
		<object id="holo_projector" x="15" y="5" />
	</area>
	<area id="RB_ship_power" width="30" height="10">
		<tiles id="ship" start="0" end="1" />
		<action>
			for(x in 10...19) for(y in 1...10) mine(x,y);
			for(x in 0...10) mine(x,5);
			for(y in 3...8) setTile(18,y,"empty");
		</action>
		<object id="RB_power_cores.broken" x="18" y="7" />
	</area>
	<area id="RB_ship_storage" width="30" height="10">
		<tiles id="ship" start="0" end="1" />
		<action>
			for(x in 14...19) for(y in 2...7) mine(x,y);
			for(x in 19...31) mine(x,5);
		</action>
		<structure id="bunker_depot" x="14" y="6">
			this.inventory.addItems(Item.get("titanium"), 20);
			this.inventory.addItems(Item.get("exotic_matter"), 2);
			this.inventory.addItems(Item.get("ship_parts"),2);
			this.inventory.addItems(Item.get("sulfur"),20);
			this.inventory.addItems(Item.get("steel_bar"),30);
			this.inventory.addItems(Item.get("coal"),20);
			this.inventory.addItems(Item.get("silicon"),20);
		</structure>
	</area>
	<area id="RB_ship_destroyed" width="60" height="30">
		<tiles id="ship" start="0" end="1" />
		<action>for(x in 10...51) for(y in 1...26) mine(x,y); for(x in 0...11) mine(x,1);</action>
		<structure id="bunker_factory.destroyed" x="11" y="25" />
		<structure id="bunker.destroyed" x="21" y="25" />
		<structure id="bunker_kitchen.destroyed" x="25" y="25" />
		<structure id="bunker_factory.destroyed" x="30" y="25" />
		<structure id="bunker_farm.destroyed" x="40" y="25" />
		<structure id="hydroponics.destroyed" x="40" y="15" />
		<structure id="hydroponics.destroyed" x="42" y="15" />
		<structure id="hydroponics.destroyed" x="44" y="15" />
		<structure id="hydroponics.destroyed" x="46" y="15" />
		<structure id="hydroponics.destroyed" x="48" y="15" />
	</area>
	<planet id="robot_rebellion" height="42">
		<orbit id="robot_rebellion.orbit" width="406" height="64" background="stars.dwarf.orbit" name="system.planet.robot">
			<area id="robot_start" x="0" />
			<spawner id="RB_enemy_ship" time="500" count="5" fromX="2" toX="402" fromY="10" toY="54" ground="false" />
			<init><runAreaLoad /><action>area.spawner.spawnAll("RB_enemy_ship")</action></init>
			<onLoad>
				<music id="orbit" seconds="1" /><radar tile="orbit.radar" animation="orbit.radar" padding="2" />
				<section if="player.hasItem('com_device') && !player.hasQuest('RB_old_ship')">
					<dialogue section="player" id="RB_old_ship_detect" speaker='player' />
					<quest id="RB_old_ship" ask="false" />
				</section>
				<section>
					<action>setFlag('on_RB_planet',true);</action>
					<run procedure="heat_damage" />
				</section>
			</onLoad>
			<onLeave>
				<action>setFlag('on_RB_planet',false);</action>
			</onLeave>
		</orbit>
	</planet>
</areas>
