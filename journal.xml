<?xml version='1.0' encoding='utf-8'?>
<data>
    <action>
        function ifNull(item, value) {
            return item == null ? value : item;
        }
    </action>

    <data type="journal_collection">
		this.id = this.xml.get('id');
		this.journals = function() {
			if(this._journals == null) {
				this._journals = [];
				for(journal in this.xml.elementsNamed('journal')) {
                    var journalData = getData('journal', journal.get('id'));
					this._journals.push({id: journal.get('id'), icon: journalData.icon, found: journalData.xml.get('found')});
				}
			}
            return this._journals;
		}
    </data>

    <data type="journal">
        this.id = this.xml.get('id');
        this.length = Std.parseInt(this.xml.get('length'));
        this.icon = this.xml.get('icon');
        this.found = ifNull(this.xml.get('found'), "getFlag('journal_" + this.id + "_found')");
        this.getPage = function(pageNumber) {
            if(pageNumber >= this.length) return null;
            if(this._pages == null) {
                this._pages = [];
                var i = 1;
                for(page in this.xml.elementsNamed('page')) {
                    var pageIndex = Std.parseInt(page.get('index'));
                    // insert default pages for missing pages in the tag
                    while(pageIndex > i) {
                        this._pages.push({index: i, found: 'getFlag("this.id' + '_journal_' + pageIndex + '")'});
                        i++;
                    }
                    // insert page with custom found condition at this index
                    this._pages.push({index: pageIndex, found: page.get('found')});
                    i++;
                }
            }
            return this._pages[pageNumber - 1];
        }
    </data>

    <journal_collection id="thirallan">
        <journal id="peredur" />
        <journal id="thirallan_misc" />
        <journal id="thirallan_characters" />
        <journal id="thirallan_happenings" />
    </journal_collection>

    <journal id="peredur" length="6" icon="mage" found="getFlag('found_peredur_desk')">
        <page index="1" found="getFlag('found_peredur_desk')" />
        <page index="2" found="getFlag('found_peredur_desk')" />
        <page index="3" found="getFlag('found_peredur_desk')" />
        <page index="4" found="getFlag('found_peredur_desk')" />
        <page index="5" found="getFlag('found_peredur_desk')" />
        <page index="6" found="getFlag('found_peredur_desk')" />
    </journal>
    <journal id="thirallan_misc" length="3" icon="thirallan_note.ico" found="getFlag('journal_thirallan_misc_found')">
        <page index="1" found="getFlag('thirallan_misc1')" />
        <page index="2" found="getFlag('thirallan_misc2')" />
        <page index="3" found="getFlag('thirallan_misc3')" />
    </journal>
    <journal id="thirallan_characters" length="17" icon="guard_chief" found="player.hasQuest('proving_worth')">
        <page index="1" found="player.hasQuest('proving_worth')" /><!--Zargoroth-->
        <page index="2" found="getFlag('pyrrhos_met')" /><!--Pyrrhos-->
        <page index="3" found="getFlag('tomkin_know')" /><!--Tomkin-->
        <page index="4" found="player.hasQuest('find_jacominus')" /><!--Andreas-->
        <page index="5" found="player.questComplete('find_jacominus')" /><!--Jacominus-->
        <page index="6" found="player.hasQuest('blood_moon')" /><!--Peredur-->
        <page index="7" found="player.hasQuest('rebuild_monastery')" /><!--Gilbert-->
        <page index="8" found="player.hasQuest('rebuild_monastery')" /><!--Hadvarr-->
        <page index="9" found="player.hasQuest('rebuild_monastery')" /><!--Ligart-->
        <page index="10" found="player.hasQuest('rebuild_monastery')" /><!--Azriel-->
        <page index="11" found="getFlag('met_paul')" /><!--Paul-->
        <page index="12" found="player.hasQuest('guild_init')" /><!--Asim-->
        <page index="13" found="player.hasQuest('lost_artifact')" /><!--Umazz-->
        <page index="14" found="player.hasQuest('guild_init')" /><!--Oviar-->
        <page index="15" found="player.questComplete('guild_init')" /><!--Zhak'vik-->
        <page index="16" found="player.questComplete('guild_init')" /><!--Mundatorem-->
        <page index="17" found="getFlag('iterol_introduced')" /><!--Iterol-->
        <page index="18" found="player.questComplete('undead_shrines')" /><!--Purifier-->
    </journal>

    <journal id="thirallan_happenings" length="1" icon="" found="getFlag('journal_thirallan_happenings_found')">
        <page index="1" found="getFlag('busted_lock_convo')" /><!--Hint for Cathedral Dungeon Key-->
    </journal>

    <window id="journals_overview" type="xml" closeButton="true" closeable="true" width="120" height="128">
        <text section="journal" id="select" x="60" y="4" center="true" />
        <list x="2" y="16" cols="1" rows="9">
            <renderer width="116" height="16">
                <tile id="item.icon" x="0" y="0"/>
                <text text="item.text" x="20" y="0" align="left"/>
                <onSelect>
                    <action>
					    window.close();
                    </action>
                    <set id="journalId" value="item.id" />
                    <set id="pageNumber" value="1" />
                    <set id="journalName" value="item.text" />
                    <run procedure="journal_view" />
                </onSelect>
            </renderer>
            <init>
                for(journal in getData('journal_collection', 'thirallan').journals()){
                    var tempFound = ifNull(getData('journal', journal.id).xml.get('found'), "getFlag('journal_" + this.id + "_found')");
                    if(eval(tempFound)) {
                        trace(journal.id+" is unlocked");
                        addItem({id: journal.id, icon: journal.icon, text: getText('journal&gt;'+journal.id).get()});
                    }
                }
            </init>
        </list>
    </window>

    <procedure id="journal_view">
        <action>
            // variables needed: journal id, page number
            var window = '&lt;window type="xml" closeButton="true" closeable="true" width="120" height="128"&gt;';
            if(journalId == 'thirallan_misc'){
                window += '&lt;text text="' + getText(journalId+'&gt;name_'+pageNumber).get() + '" x="60" y="4" center="true" /&gt;';
            } else window += '&lt;text text="' + journalName + '" x="60" y="4" center="true" /&gt;';
            window += '&lt;formattedText ';
            if(eval(getData('journal', journalId).getPage(pageNumber).found)) {
                window += 'text="' + getText(journalId + '&gt;journal_' + pageNumber).get() + '"';
            } else {
                window += 'section="journal" id="not_found"';
            }
            window += ' x="2" y="16" width="116" /&gt;';

            window += '&lt;button x="15" y="112" width="18" height="12"&gt;
                &lt;text x="1" y="1" align="left" text="Exit"/&gt;
                    &lt;onSelect&gt;
                        &lt;action&gt;
                            window.close();
                        &lt;/action&gt;
                        &lt;window id="journals_overview" /&gt;
                    &lt;/onSelect&gt;
                &lt;/button&gt;';

            if(pageNumber &gt; 1){
                window += '&lt;button x="40" y="112" width="30" height="12"&gt;
                &lt;text x="1" y="1" align="left" text="Prev."/&gt;
                    &lt;onSelect&gt;
                        &lt;action&gt;
                            window.close();
                        &lt;/action&gt;
                        &lt;set id="pageNumber" value="pageNumber-1" /&gt;
                        &lt;run procedure="journal_view" /&gt;
                    &lt;/onSelect&gt;
                &lt;/button&gt;';
            }
            if(Std.parseInt(getData('journal', journalId).length) &gt; pageNumber){
                window += '&lt;button x="75" y="112" width="30" height="12"&gt;
                &lt;text x="1" y="1" align="left" text="Next"/&gt;
                    &lt;onSelect&gt;
                        &lt;action&gt;
                            window.close();
                        &lt;/action&gt;
                        &lt;set id="pageNumber" value="pageNumber+1" /&gt;
                        &lt;run procedure="journal_view" /&gt;
                    &lt;/onSelect&gt;
                &lt;/button&gt;';
            }
            window += '&lt;/window&gt;';
            evalXml(window);
        </action>
    </procedure>
    
    

    <item id="thirallan_journal" type="tool" canStore="false">
        <action id="use">
            <window id="journals_overview" />
        </action>
    </item>

    <lang id="en_US">
        <section id="journal">
            <text id="select">Select a journal</text>
            <text id="not_found">You haven't found this page yet</text>
            <text id="peredur">Peredur's Journal</text>
            <text id="thirallan_characters">Thirallan Inhabitants</text>
            <text id="thirallan_misc">Misc. Thirallan Notes</text>
            <text id="thirallan_happenings">Thirallan Events</text>
        </section>
        <section id="peredur">
            <text id="journal_1">Entry one, who knows what date: The Purifier's Guild is wrong. They don't realize it but the Dark God will forsake them once they finish his will. They don't understand they are bringing about their own demise.</text>
            <text id="journal_2">Now I sit here in some ruins under a town that would likely shun someone like me, contemplating what to do with my life, how to restart, how to at least attempt to redeem myself.</text>
            <text id="journal_3">I think I have to start looking into how to stop the Dark God. How to combat his corruption. I need prove to myself that I can do great things. I'll start tomorrow.</text>
            <text id="journal_4">Entry two, Day Ten: I managed to capture some corrupted while avoiding detection, I should understand corruption well given my ability to cast it, but I really don't know how it works.</text>
            <text id="journal_5">Its not some physical element I can detect, all it seems to change is the blood of the corrupted, from a typical red blood to a bright purple. How would I stop it from converting? Is there a way to prevent it?</text>
            <text id="journal_6">I think it may be worth trying to communicate with the villagers on the surface, if it gets bad I can leave, it shouldn't hurt to try right?</text>
        </section>
        <section id="thirallan_misc">
            <text id="name_1">Mines Note 1</text>
            <text id="name_2">Mines Note 2</text>
            <text id="name_3">Mines Note 3</text>
            <text id="journal_1">We're noticing strange energy in this stone, it was barely detectable from the surface, but here its far more noticeable. Will note signs of Dark Cult.</text>
            <text id="journal_2">The cult must know we are here, cave ins are rampant now, the stones almost seem to be shifting. I'm worried workers will get trapped in our checkpoints. We shoud be safe enough though.</text>
            <text id="journal_3">In one of the ruins down here, we found likely evidence of the cult. There is this statue depicting an angel. How strange that the cult would make this, why? It gives off a strange energy so it has to be them.</text>
        </section>
        <section id="thirallan_characters">
            <text id="journal_1">[object=zargoroth_npc]: Leader of Zargoroth's Safe Haven, he alongside [color=770000]Pyrrhos[/color] founded the town they live in.</text>
            <text id="journal_2">[object=pyrrhos]: Co-founder of Zargoroth's Safe Haven, specifically noted to be a pacifist, only engaging in the trades.</text>
            <text id="journal_3">[object=tomkin]: Younger brother of Zargoroth. Noted to be very timid. [color=770000]Zargoroth[/color] cares very deeply for him and wants to help him excel.</text>
            <text id="journal_4">[object=andreas]: A former knight that was reduced to mining only after a severe traumatic encounter with the [color=490068]The Corrupted[/color].</text>
            <text id="journal_5">[tile=jacominus2] [color=770000]Jacominus[/color]: Close friend of Andreas. Unfortunately was corrupted deep in the mines. I had no choice but to put him to rest.</text>
            <text id="journal_6">[object=peredur]: A secluded Mage that lurks around Zargoroth's Safe Haven. Incredibly interested in his research, and seems to stop at nothing to pursue it.</text>
            <text id="journal_7">[object=gilbert_template]: Leader of the Church Survivors, him and few others reside in the broken down Monastery, attempting to restore Thirallan to it's former glory.</text>
            <text id="journal_8">[object=hadvarr_template]: Co-leader of the Church Survivors, very skilled archer that used to be in high ranking at the Monastery before everything was destroyed. Very loyal.</text>
            <text id="journal_9">[object=ligart]: Why does no one else acknowledge this guy? Am I just going insane or is he really there? If so then who is he?</text>
            <text id="journal_10">[object=azriel]: The last known remaining priest still in Thirallan. Still holds true in his faith and yearns to be the next leader of the Monastery.</text>
            <text id="journal_11">[object=paul]: The only alive prisoner held by the Church Survivors, the only reason he's still alive is because Azriel was feeding him in secret. He's surprisingly content with life even while being blind in this place.</text>
            <text id="journal_12">[object=asim]: Leader of the Purifier's Guild. Has faith that the Purifier will protect them as long as they continue to worship him.</text>
            <text id="journal_13">[object=umazz]: Archivist of the Purifier's Guild, has extensive knowledge of the island's past. His dedication to finding lost artifacts of the past is admirable.</text>
            <text id="journal_14">[object=oviar]: Recruit in the Purifier's Guild. He seems to mostly act as a gatekeeper to Asim. Unsure how powerful he actually is compared to the rest of them.</text>
            <text id="journal_15">[object=zhak_vik]: A necromancher in the Purifier's Guild, apparently has the ability to conjure Corrupted from nothing. He aspires to succeed the Purifier itself.</text>
            <text id="journal_16">[object=mundatorem]: What is this guy? I get a sinking feeling everytime I look at it. It's eyes stare straight into my soul. Probably for the better if I didn't interact with it</text>
            <text id="journal_17">[object=iterol]: Something of a scientist, which seems to be a rarity in this place. He seems to believe that the Corruption is some kind of air-borne illness.</text>
            <text id="journal_18">[tile=campaign_purifier_head_journal] [color=770000]The Purifier[/color]: Also known as the Dark God. This being seems to be the direct source of the Corrupted that plagues this planet. </text>
        </section>
        <section id="thirallan_happenings">
            <text id="journal_1">I overheard [object=gilbert_template] talking to someone else about a broken trapdoor. He said it was at the top of the cathedral, where the bell is. Maybe I should check that.</text>
        </section>
    </lang>

        <onLoad>
            <section>
                <action if="!getLocalPlayer().hasItem('thirallan_journal') && getLocalPlayer().areas.exists('thirallan_zargoroth')">getLocalPlayer().addItem('thirallan_journal', 1);</action>
                <action if="getLocalPlayer().hasItem('mines_note1') || getLocalPlayer().hasItem('mines_note2')">
                    setFlag('journal_thirallan_misc_found', true);
                    if(getLocalPlayer().hasItem('mines_note1')){
                        getLocalPlayer().addItem('mines_note1', -1);
                        setFlag('thirallan_misc1', true);
                    }
                    if(getLocalPlayer().hasItem('mines_note2')){
                        getLocalPlayer().addItem('mines_note2', -1);
                        setFlag('thirallan_misc2', true);
                    }
                    evalXml('&lt;show tooltip="popup" text="common.found_journal{value:'+'Misc. Thirallan Notes'+'}" x="0.5" y="0.0625" hold="200" /&gt;');
                </action>
            </section>
        </onLoad>

</data>